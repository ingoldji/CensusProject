# -*- coding: utf-8 -*-
"""
Created on Fri Feb 20 07:00:51 2015

@author: Jillian
"""
###This code pulls a list of FIPS Codes, state abbreviations and county names
###Uses the state codes to pull zip code level population data from the 2010 census
###And joins the state abbreviations from the FIPS file into the census data

##PART I: PULLING FIPS FILE
import urllib2
import pandas as pd
import re

#pulling the state and county names and their FIPS codes for 2010 census
URL = 'http://www2.census.gov/geo/docs/reference/codes/files/national_county.txt'
html = urllib2.urlopen(URL).read()
#saving the data as a text file
testtext = open("FilePathAndName.txt", "w")
print>>testtext, html

#Making lists for each variable
State = []
StateFP = []
CountyFP = []
CountyName = []
ClassFP = []

results = []
with open('FilePathAndName.txt') as inputfile:
    for line in inputfile:
        results.append(line.strip().split(','))

for record in results:
    if record != ['']:
        State.append(record[0])
        StateFP.append(record[1])
        CountyFP.append(record[2])
        CountyName.append(record[3])
        ClassFP.append(record[4])

#converting to data frame    
d = {
        'StateAbbr': State,
        'StateFP': StateFP,
        'CountyFP': CountyFP,
        'CountyName': CountyName,
        'ClassFP': ClassFP,
    } 

CountyStateFP = pd.DataFrame(data=d)

##PART II: USING FIPS CODES TO PULL CENSUS DATA

#Getting a unique list of state codes
StateCodes = CountyStateFP['StateFP'].unique()

#Pulling census zip-code-level population data using those codes
BASE_URL = 'http://api.census.gov/data/2010/sf1?get=P0010001&for=zip+code+tabulation+area:*&in=state:'
url_end = '&key=YourCensusAPIkey'

St_list = []
Pop_list = []
Zip_list = []
for state in StateCodes:
    url = BASE_URL + state + url_end
    html = urllib2.urlopen(url).read()
    records = re.findall('\["([0-9]*)","([0-9]*)","([0-9]*)"\]',html)
    for record in records:
        Pop_list.append(record[0])
        St_list.append(record[1])
        Zip_list.append(record[2])

d = {
        'stateCode': St_list,
        'zipCode': Zip_list,
        '2010pop': Pop_list,
    } 

PopulationByZip = pd.DataFrame(data=d)


##PART III: Bringing the state abbreviations from the FIPS data into the census data

FIPS2= CountyStateFP[["StateAbbr","StateFP"]]
FIPS2 = FIPS2.drop_duplicates()
StateAbbrev = FIPS2.set_index("StateFP")

pop2 = PopulationByZip
pop2["CodeInd"] = pop2["stateCode"]
pop2 = pop2.set_index("CodeInd")

PopByZip = pop2.join(StateAbbrev, how='left')

#Saving combined file as csv; **NOTE: this strips codes of leading zeros**
PopByZip.to_csv('FilePathAndName.csv')

